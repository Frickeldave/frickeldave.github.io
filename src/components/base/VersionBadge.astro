---
/**
 * VersionBadge Component
 *
 * Floating badge that shows version info in non-production environments
 * - Local: Shows branch + commit
 * - Dev: Shows dev version + commit
 * - Production: Hidden
 */

// Fetch version info from public/version.json (generated at build time)
// Use client-side loading to avoid build-time dependency
---

<div id="version-badge" class="version-badge"></div>

<script>
  // Load version info and render badge
  async function loadVersionInfo() {
    try {
      const response = await fetch("/version.json");
      const versionInfo = await response.json();

      // Only show in non-production environments
      if (versionInfo.environment === "production") {
        return;
      }

      const badge = document.getElementById("version-badge");
      if (!badge) return;

      // Build badge content
      const envColor =
        versionInfo.environment === "local" ? "bg-blue-500" : "bg-green-500";
      const buildDate = new Date(versionInfo.buildTime).toLocaleString(
        "de-DE",
        {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        }
      );

      badge.innerHTML = `
        <div class="glass p-2 rounded-lg shadow-lg text-xs space-y-1">
          <div class="flex items-center gap-2">
            <span class="${envColor} text-white px-2 py-0.5 rounded text-[10px] font-bold uppercase">
              ${versionInfo.environment}
            </span>
            <span class="font-mono font-bold text-gray-900 dark:text-gray-100">${versionInfo.version}</span>
          </div>
          <div class="text-gray-900 dark:text-gray-400 space-y-0.5">
            <div class="flex items-center gap-1">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              <span class="font-mono">${versionInfo.commit}</span>
            </div>
            <div class="flex items-center gap-1">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
              </svg>
              <span class="truncate max-w-[120px]">${versionInfo.branch}</span>
            </div>
            <div class="flex items-center gap-1">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>${buildDate}</span>
            </div>
          </div>
        </div>
      `;

      // Make badge visible with fade-in animation
      setTimeout(() => badge.classList.add("visible"), 100);
    } catch (error) {
      console.warn("Could not load version info:", error);
    }
  }

  // Load on page load
  loadVersionInfo();

  // Make badge draggable
  let isDragging = false;
  let currentX: number;
  let currentY: number;
  let initialX: number;
  let initialY: number;
  let xOffset = 0;
  let yOffset = 0;

  function dragStart(e: MouseEvent | TouchEvent) {
    const badge = document.getElementById("version-badge");
    if (!badge) return;

    if (e.type === "touchstart") {
      const touch = (e as TouchEvent).touches[0];
      initialX = touch.clientX - xOffset;
      initialY = touch.clientY - yOffset;
    } else {
      initialX = (e as MouseEvent).clientX - xOffset;
      initialY = (e as MouseEvent).clientY - yOffset;
    }

    if ((e.target as HTMLElement).closest("#version-badge")) {
      isDragging = true;
      badge.style.cursor = "grabbing";
    }
  }

  function dragEnd() {
    const badge = document.getElementById("version-badge");
    if (badge) {
      badge.style.cursor = "grab";
    }
    isDragging = false;

    // Save position to localStorage
    localStorage.setItem("versionBadgeX", xOffset.toString());
    localStorage.setItem("versionBadgeY", yOffset.toString());
  }

  function drag(e: MouseEvent | TouchEvent) {
    if (!isDragging) return;

    e.preventDefault();

    if (e.type === "touchmove") {
      const touch = (e as TouchEvent).touches[0];
      currentX = touch.clientX - initialX;
      currentY = touch.clientY - initialY;
    } else {
      currentX = (e as MouseEvent).clientX - initialX;
      currentY = (e as MouseEvent).clientY - initialY;
    }

    xOffset = currentX;
    yOffset = currentY;

    const badge = document.getElementById("version-badge");
    if (badge) {
      badge.style.transform = `translate(${currentX}px, ${currentY}px)`;
    }
  }

  // Load saved position from localStorage
  function loadSavedPosition() {
    const savedX = localStorage.getItem("versionBadgeX");
    const savedY = localStorage.getItem("versionBadgeY");

    if (savedX && savedY) {
      xOffset = parseInt(savedX);
      yOffset = parseInt(savedY);

      const badge = document.getElementById("version-badge");
      if (badge) {
        badge.style.transform = `translate(${xOffset}px, ${yOffset}px)`;
      }
    }
  }

  // Add event listeners after badge is loaded
  setTimeout(() => {
    const badge = document.getElementById("version-badge");
    if (!badge) return;

    // Load saved position
    loadSavedPosition();

    // Mouse events
    badge.addEventListener("mousedown", dragStart);
    document.addEventListener("mousemove", drag);
    document.addEventListener("mouseup", dragEnd);

    // Touch events for mobile
    badge.addEventListener("touchstart", dragStart);
    document.addEventListener("touchmove", drag);
    document.addEventListener("touchend", dragEnd);
  }, 200);
</script>

<style>
  .version-badge {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    pointer-events: auto;
    cursor: grab;
    user-select: none;
    touch-action: none;
  }

  .version-badge.visible {
    opacity: 1;
  }

  .version-badge:active {
    cursor: grabbing;
  }

  /* Responsive: smaller on mobile */
  @media (max-width: 640px) {
    .version-badge {
      font-size: 0.7rem;
    }
  }
</style>
