---
import BaseLayout from "@components/base/BaseLayout.astro";
import { getLinkById, getLinkMappings } from "@/lib/redirectService";

export async function getStaticPaths() {
  const mappings = await getLinkMappings();
  return Object.keys(mappings.links).map((id) => ({
    params: { id },
  }));
}

const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/404");
}

const link = await getLinkById(id);

if (!link) {
  return Astro.redirect("/404");
}

const pageTitle = `Weiterleitung zu ${link.provider}`;
const pageDescription = `Du wirst zu ${link.title} bei ${link.provider} weitergeleitet.`;
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <main class="container mx-auto px-4 py-8">
    <div class="mx-auto max-w-2xl">
      <!-- Redirect Info Card -->
      <div class="glass glass-hover rounded-xl p-8 text-center">
        <div class="mb-6">
          <h1 class="mb-2 text-3xl font-bold">Weiterleitung</h1>
          <p class="text-gray-600 dark:text-gray-300">
            Du wirst in wenigen Sekunden weitergeleitet...
          </p>
        </div>

        <!-- Link Information -->
        <div class="mb-6 rounded-lg bg-white/10 p-6">
          <h2 class="mb-2 text-xl font-semibold">{link.title}</h2>
          <p class="mb-3 text-gray-600 dark:text-gray-300">
            {link.description}
          </p>

          <div class="flex items-center justify-center gap-4 text-sm">
            <span
              class="rounded-full bg-blue-500/20 px-3 py-1 text-blue-600 dark:text-blue-400"
            >
              {link.provider}
            </span>
            <span
              class="rounded-full bg-gray-500/20 px-3 py-1 text-gray-600 dark:text-gray-400"
            >
              {link.category}
            </span>
          </div>
        </div>

        <!-- Affiliate Disclaimer -->
        {
          link.affiliate && (
            <div class="mb-6 rounded-lg border border-yellow-500/20 bg-yellow-500/10 p-4">
              <p class="text-sm text-yellow-700 dark:text-yellow-300">
                <strong>Hinweis:</strong> Als Amazon-Partner verdiene ich an
                qualifizierten Verkäufen.
              </p>
            </div>
          )
        }

        <!-- Manual Redirect Button -->
        <div class="space-y-4">
          <a
            href={link.targetUrl}
            class="inline-block rounded-lg bg-blue-600 px-6 py-3 font-medium text-white transition-colors hover:bg-blue-700"
            rel={link.affiliate ? "nofollow sponsored" : "nofollow"}
            target="_blank"
          >
            Jetzt zu {link.provider} →
          </a>

          <p class="text-xs text-gray-500">
            Oder warte, du wirst automatisch weitergeleitet.
          </p>
        </div>
      </div>

      <!-- Back Link -->
      <div class="mt-6 text-center">
        <a
          href="javascript:history.back()"
          class="text-blue-600 hover:underline dark:text-blue-400"
        >
          ← Zurück zur vorherigen Seite
        </a>
      </div>
    </div>
  </main>

  <!-- Auto-redirect Script -->
  <script define:vars={{ targetUrl: link.targetUrl, affiliate: link.affiliate }}
  >
    // Auto-redirect after 3 seconds for affiliate links, 2 seconds for others
    const redirectDelay = affiliate ? 3000 : 2000;

    setTimeout(() => {
      window.location.href = targetUrl;
    }, redirectDelay);
  </script>
</BaseLayout>
