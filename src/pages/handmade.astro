---
import BaseLayout from "@components/base/BaseLayout.astro";
import Card from "@components/handmade/Card.astro";
import Sidebar from "@components/handmade/Sidebar.astro";
import PageHeader from "@components/common/PageHeader.astro";
import type { HandmadeData } from "@/types";
import type { ImageMetadata } from "astro";

// Import handmade data directly
import handmadeDataRaw from "../../public/data/handmade.json";
const handmadeData = handmadeDataRaw as HandmadeData;

// Filter only visible products
const products = handmadeData.products.filter((p) => p.visible);

// Automatically import all images from handmade folder using Vite's glob import
const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/handmade/**/*.{png,jpg,jpeg,webp}",
  { eager: true }
);

// Create a map of filename (without path) to image
const imageMap = Object.entries(images).reduce(
  (acc, [path, image]) => {
    const filename = path.split("/").pop() || "";
    acc[filename] = image.default;
    return acc;
  },
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  {} as Record<string, any>
);

// Helper function to get image for product
const getProductImage = (picturePath: string) => {
  const filename = picturePath.split("/").pop() || "";
  return imageMap[filename];
};

// Get unique categories and tags
const categories = [...new Set(products.map((p) => p.category))];
const allTags = [...new Set(products.flatMap((p) => p.tags))].sort();
---

<BaseLayout
  title="Handmade - Unsere handgefertigten Produkte"
  description="Entdecke unsere handgefertigten Produkte aus Holz, 3D-Druck, Laser und Epoxidharz. Einzigartige Geschenke und Dekorationen."
>
  <PageHeader title="Handmade Produkte" />

  <!-- Mobile Filter Bar (visible only on small screens) -->
  <section class="lg:hidden section py-2">
    <div class="container">
      <div class="glass rounded-lg p-4 space-y-4">
        <!-- Search and Sort Row -->
        <div class="flex gap-2">
          <input
            type="text"
            id="mobile-search-input"
            placeholder="Suche nach Name, Beschreibung oder Artikelnummer..."
            class="flex-1 px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-sm placeholder-white/70 focus:outline-none focus:border-blue-400"
          />
          <select
            id="mobile-sort-select"
            class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-sm focus:outline-none focus:border-blue-400"
          >
            <option value="name-asc">Name A-Z</option>
            <option value="name-desc">Name Z-A</option>
            <option value="price-asc">Preis ↑</option>
            <option value="price-desc">Preis ↓</option>
          </select>
        </div>

        <!-- Filter Toggles Row -->
        <div class="flex gap-2">
          <!-- Categories Toggle -->
          <button
            id="mobile-categories-toggle"
            class="flex-1 px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-sm hover:bg-white/20 transition-all duration-200 flex items-center justify-between"
          >
            <span>Kategorien</span>
            <svg
              class="w-4 h-4 transform transition-transform"
              id="mobile-categories-arrow"
            >
              <path
                stroke="currentColor"
                stroke-width="2"
                d="M6 9l6 6 6-6"
                fill="none"></path>
            </svg>
          </button>

          <!-- Tags Toggle -->
          <button
            id="mobile-tags-toggle"
            class="flex-1 px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-sm hover:bg-white/20 transition-all duration-200 flex items-center justify-between"
          >
            <span>Tags</span>
            <svg
              class="w-4 h-4 transform transition-transform"
              id="mobile-tags-arrow"
            >
              <path
                stroke="currentColor"
                stroke-width="2"
                d="M6 9l6 6 6-6"
                fill="none"></path>
            </svg>
          </button>

          <!-- Customizable Filter -->
          <label
            class="flex items-center gap-2 px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-sm cursor-pointer hover:bg-white/20"
          >
            <input
              type="checkbox"
              id="mobile-customizable-filter"
              class="w-4 h-4 rounded border-white/30"
            />
            <span class="text-sm">✨ Personalisierbar</span>
          </label>
        </div>

        <!-- Categories Dropdown (initially hidden) -->
        <div id="mobile-categories-dropdown" class="hidden">
          <div class="grid grid-cols-2 gap-2">
            {
              categories.map((category) => (
                <button
                  class="mobile-category-filter px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-sm hover:bg-white/20 transition-all duration-200 text-left"
                  data-category={category}
                >
                  {category}
                </button>
              ))
            }
          </div>
        </div>

        <!-- Tags Dropdown (initially hidden) -->
        <div id="mobile-tags-dropdown" class="hidden">
          <div class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto">
            {
              allTags.map((tag) => (
                <button
                  class="mobile-tag-filter px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-sm hover:bg-white/20 transition-all duration-200 text-left"
                  data-tag={tag}
                >
                  {tag}
                </button>
              ))
            }
          </div>
        </div>

        <!-- Results Count and Clear Button -->
        <div
          class="flex justify-between items-center pt-2 border-t border-white/20"
        >
          <div id="mobile-results-count" class="text-sm opacity-70">
            {products.length} von {products.length} Produkten
          </div>
          <button
            id="mobile-clear-filters"
            class="px-3 py-1 bg-red-500/20 border border-red-400/30 rounded text-sm hover:bg-red-500/30 transition-all duration-200"
          >
            Filter zurücksetzen
          </button>
        </div>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="flex container">
      <div class="row px-0 mx-0 w-full">
        <!-- Products Grid -->
        <div class="col-12 lg:col-8 lg:p-0">
          <!-- Products Grid -->
          <div
            id="products-grid"
            class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8"
          >
            {
              products.map((product) => (
                <div
                  class="product-card"
                  data-article-number={product.articleNumber}
                  data-name={product.name.toLowerCase()}
                  data-description={product.description.toLowerCase()}
                  data-category={product.category}
                  data-tags={JSON.stringify(product.tags)}
                  data-price={product.price}
                  data-customizable={product.customizable}
                >
                  <Card
                    item={product}
                    image={getProductImage(product.picture)}
                  />
                </div>
              ))
            }
          </div>

          <!-- No Results Message -->
          <div
            id="no-results"
            class="hidden text-center py-12 glass rounded-lg"
          >
            <p class="text-xl opacity-70">
              Keine Produkte gefunden. Versuche andere Filter.
            </p>
          </div>
        </div>

        <!-- Sidebar -->
        <div
          class="hidden lg:col-4 lg:flex max-h-static_sidemenu sticky p-0 pl-4 top-[4rem]"
        >
          <Sidebar
            categories={categories}
            allTags={allTags}
            totalProducts={products.length}
          />
        </div>
      </div>
    </div>
  </section>

  <script>
    // Force script re-execution on each page load
    (() => {
      // Client-side filtering and sorting logic
      let selectedCategories: string[] = [];
      let selectedTags: string[] = [];
      let searchQuery = "";
      let sortBy = "name-asc";
      let filterCustomizable = false;

      function initializeFilters() {
        console.log("Initializing handmade filters...");

        // Desktop elements
        const searchInput = document.getElementById(
          "search-input"
        ) as HTMLInputElement;
        const sortSelect = document.getElementById(
          "sort-select"
        ) as HTMLSelectElement;
        const customizableCheckbox = document.getElementById(
          "customizable-filter"
        ) as HTMLInputElement;
        const clearButton = document.getElementById("clear-filters");
        const productsGrid = document.getElementById("products-grid");
        const resultsCount = document.getElementById("results-count");
        const noResults = document.getElementById("no-results");
        const categoryButtons = document.querySelectorAll(".category-filter");
        const tagButtons = document.querySelectorAll(".tag-filter");

        // Mobile elements
        const mobileSearchInput = document.getElementById(
          "mobile-search-input"
        ) as HTMLInputElement;
        const mobileSortSelect = document.getElementById(
          "mobile-sort-select"
        ) as HTMLSelectElement;
        const mobileCustomizableCheckbox = document.getElementById(
          "mobile-customizable-filter"
        ) as HTMLInputElement;
        const mobileClearButton = document.getElementById(
          "mobile-clear-filters"
        );
        const mobileResultsCount = document.getElementById(
          "mobile-results-count"
        );
        const mobileCategoryButtons = document.querySelectorAll(
          ".mobile-category-filter"
        );
        const mobileTagButtons =
          document.querySelectorAll(".mobile-tag-filter");

        // Mobile toggle elements
        const mobileCategoriesToggle = document.getElementById(
          "mobile-categories-toggle"
        );
        const mobileTagsToggle = document.getElementById("mobile-tags-toggle");
        const mobileCategoriesDropdown = document.getElementById(
          "mobile-categories-dropdown"
        );
        const mobileTagsDropdown = document.getElementById(
          "mobile-tags-dropdown"
        );
        const mobileCategoriesArrow = document.getElementById(
          "mobile-categories-arrow"
        );
        const mobileTagsArrow = document.getElementById("mobile-tags-arrow");

        // Early return if essential elements don't exist
        if (!productsGrid || !noResults) {
          console.warn(
            "Essential handmade filter elements not found, retrying in 100ms..."
          );
          setTimeout(initializeFilters, 100);
          return;
        }

        function updateDisplay() {
          const productCards =
            productsGrid?.querySelectorAll(".product-card") || [];
          let visibleCount = 0;

          const sortedCards = Array.from(productCards).sort((a, b) => {
            const aPrice = parseFloat(a.getAttribute("data-price") || "0");
            const bPrice = parseFloat(b.getAttribute("data-price") || "0");
            const aName = a.getAttribute("data-name") || "";
            const bName = b.getAttribute("data-name") || "";

            switch (sortBy) {
              case "price-asc":
                return aPrice - bPrice;
              case "price-desc":
                return bPrice - aPrice;
              case "name-asc":
                return aName.localeCompare(bName);
              case "name-desc":
                return bName.localeCompare(aName);
              default:
                return 0;
            }
          });

          // Filter and sort cards WITHOUT DOM manipulation to preserve event listeners
          sortedCards.forEach((card, index) => {
            const category = card.getAttribute("data-category") || "";
            const tags = JSON.parse(card.getAttribute("data-tags") || "[]");
            const name = card.getAttribute("data-name") || "";
            const description = card.getAttribute("data-description") || "";
            const articleNumber =
              card.getAttribute("data-article-number") || "";
            const customizable =
              card.getAttribute("data-customizable") === "true";

            let visible = true;

            // Filter by categories (if any selected)
            if (
              selectedCategories.length > 0 &&
              !selectedCategories.includes(category)
            ) {
              visible = false;
            }

            // Filter by tags (if any selected)
            if (
              selectedTags.length > 0 &&
              !selectedTags.every((tag) => tags.includes(tag))
            ) {
              visible = false;
            }

            // Filter by customizable
            if (filterCustomizable && !customizable) {
              visible = false;
            }

            // Filter by search
            if (searchQuery) {
              const query = searchQuery.toLowerCase();
              if (
                !name.includes(query) &&
                !description.includes(query) &&
                !articleNumber.toLowerCase().includes(query) &&
                !tags.some((tag: string) => tag.toLowerCase().includes(query))
              ) {
                visible = false;
              }
            }

            if (visible) {
              visibleCount++;
              card.classList.remove("hidden");
            } else {
              card.classList.add("hidden");
            }

            // Apply sorting with CSS order instead of DOM manipulation
            (card as HTMLElement).style.order = index.toString();
          });

          // Update results count (both desktop and mobile)
          const totalCount = productCards.length;
          const resultsText = `${visibleCount} von ${totalCount} Produkten`;

          if (resultsCount) {
            resultsCount.textContent = resultsText;
          }
          if (mobileResultsCount) {
            mobileResultsCount.textContent = resultsText;
          }

          // Show/hide no results message
          if (noResults) {
            if (visibleCount === 0) {
              noResults.classList.remove("hidden");
            } else {
              noResults.classList.add("hidden");
            }
          }
        }

        // Remove existing event listeners to prevent duplicates
        categoryButtons.forEach((button) => {
          // Clone node to remove all event listeners
          const newButton = button.cloneNode(true);
          button.parentNode?.replaceChild(newButton, button);
        });

        tagButtons.forEach((button) => {
          // Clone node to remove all event listeners
          const newButton = button.cloneNode(true);
          button.parentNode?.replaceChild(newButton, button);
        });

        // Re-get buttons after cloning
        const freshCategoryButtons =
          document.querySelectorAll(".category-filter");
        const freshTagButtons = document.querySelectorAll(".tag-filter");

        // Category filter buttons with toggle functionality (with mobile sync)
        freshCategoryButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const category = button.getAttribute("data-category") || "";

            if (selectedCategories.includes(category)) {
              // Deselect category
              selectedCategories = selectedCategories.filter(
                (c) => c !== category
              );
              button.classList.remove("!bg-blue-500/30", "!border-blue-400");
            } else {
              // Select category
              selectedCategories.push(category);
              button.classList.add("!bg-blue-500/30", "!border-blue-400");
            }

            // Sync with mobile
            document
              .querySelectorAll(
                `.mobile-category-filter[data-category="${category}"]`
              )
              .forEach((mobileBtn) => {
                if (selectedCategories.includes(category)) {
                  mobileBtn.classList.add(
                    "!bg-blue-500/30",
                    "!border-blue-400"
                  );
                } else {
                  mobileBtn.classList.remove(
                    "!bg-blue-500/30",
                    "!border-blue-400"
                  );
                }
              });

            updateDisplay();
          });
        });

        // Tag filter buttons with toggle functionality (with mobile sync)
        freshTagButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const tag = button.getAttribute("data-tag") || "";

            if (selectedTags.includes(tag)) {
              selectedTags = selectedTags.filter((t) => t !== tag);
              button.classList.remove("!bg-blue-500/30", "!border-blue-400");
            } else {
              selectedTags.push(tag);
              button.classList.add("!bg-blue-500/30", "!border-blue-400");
            }

            // Sync with mobile
            document
              .querySelectorAll(`.mobile-tag-filter[data-tag="${tag}"]`)
              .forEach((mobileBtn) => {
                if (selectedTags.includes(tag)) {
                  mobileBtn.classList.add(
                    "!bg-blue-500/30",
                    "!border-blue-400"
                  );
                } else {
                  mobileBtn.classList.remove(
                    "!bg-blue-500/30",
                    "!border-blue-400"
                  );
                }
              });

            updateDisplay();
          });
        });

        // Search input (with mobile sync)
        searchInput?.addEventListener("input", (e) => {
          searchQuery = (e.target as HTMLInputElement).value;
          if (mobileSearchInput) mobileSearchInput.value = searchQuery;
          updateDisplay();
        });

        // Sort select (with mobile sync)
        sortSelect?.addEventListener("change", (e) => {
          sortBy = (e.target as HTMLSelectElement).value;
          if (mobileSortSelect) mobileSortSelect.value = sortBy;
          updateDisplay();
        });

        // Customizable filter (with mobile sync)
        customizableCheckbox?.addEventListener("change", (e) => {
          filterCustomizable = (e.target as HTMLInputElement).checked;
          if (mobileCustomizableCheckbox)
            mobileCustomizableCheckbox.checked = filterCustomizable;
          updateDisplay();
        });

        // Clear filters button
        clearButton?.addEventListener("click", () => {
          selectedCategories = [];
          selectedTags = [];
          searchQuery = "";
          sortBy = "name-asc";
          filterCustomizable = false;

          if (searchInput) searchInput.value = "";
          if (sortSelect) sortSelect.value = "name-asc";
          if (customizableCheckbox) customizableCheckbox.checked = false;

          // Reset category buttons
          document.querySelectorAll(".category-filter").forEach((btn) => {
            btn.classList.remove("!bg-blue-500/30", "!border-blue-400");
          });

          // Reset tag buttons
          document.querySelectorAll(".tag-filter").forEach((btn) => {
            btn.classList.remove("!bg-blue-500/30", "!border-blue-400");
          });

          updateDisplay();
        });

        // ===============================
        // MOBILE FILTER EVENT LISTENERS
        // ===============================

        // Mobile toggle functionality
        mobileCategoriesToggle?.addEventListener("click", () => {
          const isOpen =
            !mobileCategoriesDropdown?.classList.contains("hidden");
          if (isOpen) {
            mobileCategoriesDropdown?.classList.add("hidden");
            mobileCategoriesArrow?.classList.remove("rotate-180");
          } else {
            mobileCategoriesDropdown?.classList.remove("hidden");
            mobileCategoriesArrow?.classList.add("rotate-180");
          }
        });

        mobileTagsToggle?.addEventListener("click", () => {
          const isOpen = !mobileTagsDropdown?.classList.contains("hidden");
          if (isOpen) {
            mobileTagsDropdown?.classList.add("hidden");
            mobileTagsArrow?.classList.remove("rotate-180");
          } else {
            mobileTagsDropdown?.classList.remove("hidden");
            mobileTagsArrow?.classList.add("rotate-180");
          }
        });

        // Mobile category filters
        mobileCategoryButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const category = button.getAttribute("data-category") || "";

            if (selectedCategories.includes(category)) {
              selectedCategories = selectedCategories.filter(
                (c) => c !== category
              );
              button.classList.remove("!bg-blue-500/30", "!border-blue-400");
            } else {
              selectedCategories.push(category);
              button.classList.add("!bg-blue-500/30", "!border-blue-400");
            }

            // Sync with desktop
            document
              .querySelectorAll(`.category-filter[data-category="${category}"]`)
              .forEach((desktopBtn) => {
                if (selectedCategories.includes(category)) {
                  desktopBtn.classList.add(
                    "!bg-blue-500/30",
                    "!border-blue-400"
                  );
                } else {
                  desktopBtn.classList.remove(
                    "!bg-blue-500/30",
                    "!border-blue-400"
                  );
                }
              });

            updateDisplay();
          });
        });

        // Mobile tag filters
        mobileTagButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const tag = button.getAttribute("data-tag") || "";

            if (selectedTags.includes(tag)) {
              selectedTags = selectedTags.filter((t) => t !== tag);
              button.classList.remove("!bg-blue-500/30", "!border-blue-400");
            } else {
              selectedTags.push(tag);
              button.classList.add("!bg-blue-500/30", "!border-blue-400");
            }

            // Sync with desktop
            document
              .querySelectorAll(`.tag-filter[data-tag="${tag}"]`)
              .forEach((desktopBtn) => {
                if (selectedTags.includes(tag)) {
                  desktopBtn.classList.add(
                    "!bg-blue-500/30",
                    "!border-blue-400"
                  );
                } else {
                  desktopBtn.classList.remove(
                    "!bg-blue-500/30",
                    "!border-blue-400"
                  );
                }
              });

            updateDisplay();
          });
        });

        // Mobile search input
        mobileSearchInput?.addEventListener("input", (e) => {
          searchQuery = (e.target as HTMLInputElement).value;
          if (searchInput) searchInput.value = searchQuery; // Sync with desktop
          updateDisplay();
        });

        // Mobile sort select
        mobileSortSelect?.addEventListener("change", (e) => {
          sortBy = (e.target as HTMLSelectElement).value;
          if (sortSelect) sortSelect.value = sortBy; // Sync with desktop
          updateDisplay();
        });

        // Mobile customizable filter
        mobileCustomizableCheckbox?.addEventListener("change", (e) => {
          filterCustomizable = (e.target as HTMLInputElement).checked;
          if (customizableCheckbox)
            customizableCheckbox.checked = filterCustomizable; // Sync with desktop
          updateDisplay();
        });

        // Mobile clear filters button
        mobileClearButton?.addEventListener("click", () => {
          selectedCategories = [];
          selectedTags = [];
          searchQuery = "";
          sortBy = "name-asc";
          filterCustomizable = false;

          // Reset mobile inputs
          if (mobileSearchInput) mobileSearchInput.value = "";
          if (mobileSortSelect) mobileSortSelect.value = "name-asc";
          if (mobileCustomizableCheckbox)
            mobileCustomizableCheckbox.checked = false;

          // Reset desktop inputs
          if (searchInput) searchInput.value = "";
          if (sortSelect) sortSelect.value = "name-asc";
          if (customizableCheckbox) customizableCheckbox.checked = false;

          // Reset all filter buttons
          document
            .querySelectorAll(".category-filter, .mobile-category-filter")
            .forEach((btn) => {
              btn.classList.remove("!bg-blue-500/30", "!border-blue-400");
            });

          document
            .querySelectorAll(".tag-filter, .mobile-tag-filter")
            .forEach((btn) => {
              btn.classList.remove("!bg-blue-500/30", "!border-blue-400");
            });

          // Close mobile dropdowns
          mobileCategoriesDropdown?.classList.add("hidden");
          mobileTagsDropdown?.classList.add("hidden");
          mobileCategoriesArrow?.classList.remove("rotate-180");
          mobileTagsArrow?.classList.remove("rotate-180");

          updateDisplay();
        });

        // Initial display update
        updateDisplay();
      }

      // Re-initialize when navigating back to page (for SPA behavior)
      document.addEventListener("astro:page-load", initializeFilters);

      // Also try after DOM content is loaded
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializeFilters);
      } else {
        // DOM is already loaded
        initializeFilters();
      }

      // Fallback for navigation events
      window.addEventListener("popstate", initializeFilters);

      // Initial call
      initializeFilters();
    })();
  </script>
</BaseLayout>
