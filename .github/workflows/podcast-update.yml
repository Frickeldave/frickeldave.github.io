name: Podcast Update

on:
  schedule:
    # Every Tuesday at 09:00 CET/CEST
    - cron: "0 8 * * 2" # 08:00 UTC = 09:00 CET (winter) / 07:00 UTC = 09:00 CEST (summer)
  workflow_dispatch:
    inputs:
      target:
        description: "Target environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - all
      dryRun:
        description: "Dry run (validate without committing)"
        required: false
        default: false
        type: boolean

jobs:
  podcast-update:
    runs-on: [self-hosted, frickeldave-main]
    defaults:
      run:
        shell: bash -il {0}
    steps:
      - name: Checkout repository (main)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check Node.js version
        run: |
          echo "ğŸ” Checking Node.js version..."
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          NODE_VERSION=$(node --version | cut -d'v' -f2 | cut -d'.' -f1)
          if [ "$NODE_VERSION" != "24" ]; then
            echo "âŒ Node.js v24 is required, but v$NODE_VERSION is installed."
            exit 1
          fi
          echo "âœ… Node.js v24 is available"

      - name: Global episode comparison (against main)
        id: check_episodes
        run: |
          echo "ğŸ“¡ Comparing RSS feed with main branch..."
          node scripts/workflows/podcast-update/compare-episodes.mjs
        env:
          GITHUB_OUTPUT: ${{ github.workspace }}/episode-check.txt

      - name: Exit if no new episodes
        if: steps.check_episodes.outputs.missing_episode == ''
        run: |
          echo "âœ… No new episodes found. All episodes are up to date."
          exit 0

      - name: Generate episode metadata using Copilot
        if: steps.check_episodes.outputs.missing_episode != ''
        id: generate_metadata
        run: |
          echo "ğŸ¤– Generating episode metadata using GitHub Copilot CLI..."
          export GITHUB_TOKEN="${{ secrets.COPILOT_GITHUB_TOKEN }}"
          node scripts/workflows/podcast-update/generate-metadata.mjs

      - name: Update dev branch
        if: steps.check_episodes.outputs.missing_episode != ''
        id: update_dev
        run: |
          TITLE=$(jq -r '.title' metadata.json)
          echo "ğŸŒ¿ Updating dev branch with episode: $TITLE"

          git checkout dev
          git pull origin dev

          if [ "${{ github.event.inputs.dryRun }}" == "true" ]; then
            node scripts/workflows/podcast-update/update-doag.mjs --dry-run
            echo "ğŸ¦ DRY RUN: Skipping git commit and push."
          else
            node scripts/workflows/podcast-update/update-doag.mjs
            git add src/content/aboutme/doag.md
            git commit -m "feat(podcast): Add episode '$TITLE'" --no-verify
            git push origin dev
          fi

      - name: Update main branch
        if: steps.check_episodes.outputs.missing_episode != '' && (github.event.inputs.target == 'all' || github.event_name == 'schedule')
        id: update_main
        run: |
          TITLE=$(jq -r '.title' metadata.json)
          echo "ğŸš€ Updating main branch with episode: $TITLE"

          git checkout main
          git pull origin main

          if [ "${{ github.event.inputs.dryRun }}" == "true" ]; then
            node scripts/workflows/podcast-update/update-doag.mjs --dry-run
            echo "ğŸ¦ DRY RUN: Skipping git commit and push."
          else
            node scripts/workflows/podcast-update/update-doag.mjs
            git add src/content/aboutme/doag.md
            git commit -m "feat(podcast): Add episode '$TITLE'" --no-verify
            git push origin main
          fi

      - name: Success summary
        if: steps.check_episodes.outputs.missing_episode != ''
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ‰ Independent Podcast Update Completed Successfully      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Summary:"
          echo "  â€¢ Episode: $(jq -r '.title' metadata.json)"
          echo "  â€¢ Branches updated: dev ${{ (github.event.inputs.target == 'all' || github.event_name == 'schedule') && 'and main' || '' }}"
          echo ""
          echo "âœ… Branches have been updated directly."
