name: deploy-dev

on:
  # Trigger when a pull request targeting `dev` is closed (merged)
  pull_request:
    types: [closed]
    branches: [dev]
  # Allows you to run this workflow manually from the Actions tab on GitHub.
  workflow_dispatch:

jobs:
  deploy-and-build:
    # Only run when manually dispatched or when the pull request was merged
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true) }}
    runs-on: [self-hosted, frickeldave-main]
    steps:
      - name: Trigger HomeNet Ansible Deployment (build tag)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.HOMENET_PAT }}
          script: |
            try {
              const result = await github.rest.actions.createWorkflowDispatch({
                owner: 'Frickeldave',
                repo: 'HomeNet',
                workflow_id: 'host-waltraud.yaml',
                ref: 'main',
                inputs: {
                  homeassistant_reset: 'false',
                  tag_select: 'frickeldave-build'
                }
              });
              console.log('Workflow dispatch successful:', result.status);
            } catch (error) {
              console.error('Error triggering workflow:', error);
              console.error('Error message:', error.message);
              console.error('Error status:', error.status);
              throw error;
            }

      - name: Log build deployment trigger
        run: |
          echo "Triggered HomeNet deployment via host-waltraud.yaml workflow (build)"
          echo "Target: waltraud-dc.yaml playbook"
          echo "Limit: waltraud"
          echo "Variables: homeassistant_reset=false, tag_select=frickeldave-build"

      - name: Trigger HomeNet Ansible Deployment (deploy tag)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.HOMENET_PAT }}
          script: |
            try {
              const result = await github.rest.actions.createWorkflowDispatch({
                owner: 'Frickeldave',
                repo: 'HomeNet',
                workflow_id: 'host-waltraud.yaml',
                ref: 'main',
                inputs: {
                  homeassistant_reset: 'false',
                  tag_select: 'frickeldave'
                }
              });
              console.log('Workflow dispatch successful:', result.status);
            } catch (error) {
              console.error('Error triggering workflow:', error);
              console.error('Error message:', error.message);
              console.error('Error status:', error.status);
              throw error;
            }

      - name: Log deploy deployment trigger
        run: |
          echo "Triggered HomeNet deployment via host-waltraud.yaml workflow (deploy)"
          echo "Target: waltraud-dc.yaml playbook"
          echo "Limit: waltraud"
          echo "Variables: homeassistant_reset=false, tag_select=frickeldave"
